<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¸”ë¡œê·¸ ìë™í™” ì›Œí¬í”Œë¡œìš° - ë„¤ì´ë²„ ë¸”ë¡œê·¸ í¬ìŠ¤íŒ… ì‹œìŠ¤í…œ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        textarea {
            height: 120px;
            resize: vertical;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .progress-container {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: #28a745;
            width: 0%;
            transition: width 0.3s ease;
        }

        .status-message {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .step-info {
            color: #666;
            font-size: 14px;
        }

        .result-container {
            margin-top: 20px;
            padding: 20px;
            border-radius: 5px;
            display: none;
        }

        .result-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .quality-scores {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 15px 0;
        }

        .quality-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
        }

        .quality-item strong {
            display: block;
            margin-bottom: 5px;
            color: #333;
        }

        .quality-score {
            font-size: 18px;
            font-weight: bold;
        }

        .score-excellent { color: #28a745; }
        .score-good { color: #17a2b8; }
        .score-fair { color: #ffc107; }
        .score-poor { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– ë¸”ë¡œê·¸ ìë™í™” ì›Œí¬í”Œë¡œìš°</h1>
        <p style="text-align: center; color: #666;">
            ë°ì´í„° ê²€ì¦ â†’ AI ë¸”ë¡œê·¸ ìƒì„± â†’ í’ˆì§ˆ ê²€ì¦ â†’ ë„¤ì´ë²„ ì„ì‹œì €ì¥ê¹Œì§€ ì™„ì „ ìë™í™”
        </p>

        <form id="workflowForm">
            <div class="form-group">
                <label for="visitDate">ë°©ë¬¸ ë‚ ì§œ*</label>
                <input type="date" id="visitDate" name="visitDate" required>
            </div>

            <div class="form-group">
                <label for="category">ì¹´í…Œê³ ë¦¬*</label>
                <select id="category" name="category" required>
                    <option value="">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="ë§›ì§‘">ë§›ì§‘</option>
                    <option value="ì œí’ˆ">ì œí’ˆ</option>
                    <option value="í˜¸í…”">í˜¸í…”</option>
                    <option value="ì—¬í–‰">ì—¬í–‰</option>
                    <option value="ë·°í‹°">ë·°í‹°</option>
                    <option value="íŒ¨ì…˜">íŒ¨ì…˜</option>
                    <option value="IT">IT</option>
                    <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                </select>
            </div>

            <div class="form-group">
                <label for="storeName">ìƒí˜¸ëª…*</label>
                <input type="text" id="storeName" name="storeName" placeholder="ì˜ˆ: ìŠ¤íƒ€ë²…ìŠ¤ ê°•ë‚¨ì—­ì " required>
                <small style="color: #666;">ì§€ì ëª…ì„ ëª¨ë¥´ë©´ ë¸Œëœë“œëª…ë§Œ ì…ë ¥í•´ë„ ë©ë‹ˆë‹¤.</small>
            </div>

            <div class="form-group">
                <label for="personalReview">ê°œì¸ ê°ìƒí‰* (ìµœì†Œ 50ì)</label>
                <textarea id="personalReview" name="personalReview" placeholder="ë°©ë¬¸í•˜ì‹  ê²½í—˜ê³¼ ëŠë‚Œì„ ìì„¸íˆ ì‘ì„±í•´ì£¼ì„¸ìš”..." required></textarea>
                <small style="color: #666;">í˜„ì¬ <span id="reviewLength">0</span>ì</small>
            </div>

            <div class="form-group">
                <label for="rating">ë³„ì </label>
                <select id="rating" name="rating">
                    <option value="">ë³„ì  ì„ íƒ (ì„ íƒì‚¬í•­)</option>
                    <option value="5">â­â­â­â­â­ (5ì )</option>
                    <option value="4">â­â­â­â­ (4ì )</option>
                    <option value="3">â­â­â­ (3ì )</option>
                    <option value="2">â­â­ (2ì )</option>
                    <option value="1">â­ (1ì )</option>
                </select>
            </div>

            <div class="form-group">
                <label for="companion">ë™í–‰ì</label>
                <select id="companion" name="companion">
                    <option value="">ë™í–‰ì ì„ íƒ (ì„ íƒì‚¬í•­)</option>
                    <option value="í˜¼ì">í˜¼ì</option>
                    <option value="ê°€ì¡±">ê°€ì¡±</option>
                    <option value="ì¹œêµ¬">ì¹œêµ¬</option>
                    <option value="ì—°ì¸">ì—°ì¸</option>
                    <option value="ë™ë£Œ">ë™ë£Œ</option>
                </select>
            </div>

            <div class="form-group">
                <label for="location">ìœ„ì¹˜</label>
                <input type="text" id="location" name="location" placeholder="ì˜ˆ: ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ (ì„ íƒì‚¬í•­)">
            </div>

            <div class="form-group">
                <label for="additionalScript">ì¶”ê°€ ìŠ¤í¬ë¦½íŠ¸</label>
                <textarea id="additionalScript" name="additionalScript" placeholder="ë¸”ë¡œê·¸ ì‘ì„± ì‹œ ì°¸ê³ í•  ì¶”ê°€ ë‚´ìš©ì´ ìˆìœ¼ë©´ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="autoUpload" name="autoUpload" checked>
                    <label for="autoUpload">ë„¤ì´ë²„ ë¸”ë¡œê·¸ ìë™ ì„ì‹œì €ì¥</label>
                </div>
            </div>

            <div style="text-align: center;">
                <button type="submit" id="startBtn">ğŸš€ ìë™í™” ì‹œì‘</button>
                <button type="button" id="cancelBtn" disabled>â¹ï¸ ì·¨ì†Œ</button>
            </div>
        </form>

        <div id="progressContainer" class="progress-container">
            <div class="status-message" id="statusMessage">ì¤€ë¹„ ì¤‘...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="step-info" id="stepInfo">0/0 ë‹¨ê³„</div>
        </div>

        <div id="resultContainer" class="result-container">
            <div id="resultContent"></div>
        </div>
    </div>

    <script>
        let currentWorkflowId = null;
        let progressInterval = null;

        // ê°ìƒí‰ ê¸€ììˆ˜ ì¹´ìš´í„°
        document.getElementById('personalReview').addEventListener('input', function() {
            const length = this.value.length;
            document.getElementById('reviewLength').textContent = length;

            if (length < 50) {
                this.style.borderColor = '#dc3545';
            } else {
                this.style.borderColor = '#28a745';
            }
        });

        // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
        document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];

        // í¼ ì œì¶œ ì²˜ë¦¬
        document.getElementById('workflowForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const data = {
                visit_date: formData.get('visitDate').replace(/-/g, ''),
                category: formData.get('category'),
                store_name: formData.get('storeName'),
                personal_review: formData.get('personalReview'),
                rating: formData.get('rating') ? parseInt(formData.get('rating')) : null,
                companion: formData.get('companion') || null,
                location: formData.get('location') || null,
                additional_script: formData.get('additionalScript') || '',
                auto_upload_to_naver: formData.has('autoUpload')
            };

            try {
                await startWorkflow(data);
            } catch (error) {
                showError('ì›Œí¬í”Œë¡œìš° ì‹œì‘ ì‹¤íŒ¨: ' + error.message);
            }
        });

        // ì·¨ì†Œ ë²„íŠ¼ ì²˜ë¦¬
        document.getElementById('cancelBtn').addEventListener('click', async function() {
            if (currentWorkflowId) {
                try {
                    await cancelWorkflow(currentWorkflowId);
                } catch (error) {
                    console.error('ì·¨ì†Œ ì‹¤íŒ¨:', error);
                }
            }
        });

        async function startWorkflow(data) {
            showProgress();

            const response = await fetch('/api/workflow/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();

            if (result.success) {
                currentWorkflowId = result.workflow_id;
                document.getElementById('startBtn').disabled = true;
                document.getElementById('cancelBtn').disabled = false;

                // ì§„í–‰ìƒí™© ëª¨ë‹ˆí„°ë§ ì‹œì‘
                startProgressMonitoring(currentWorkflowId);
            } else {
                throw new Error(result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
            }
        }

        async function cancelWorkflow(workflowId) {
            const response = await fetch(`/api/workflow/cancel/${workflowId}`, {
                method: 'POST'
            });

            if (response.ok) {
                stopProgressMonitoring();
                showError('ì‚¬ìš©ìì— ì˜í•´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                resetForm();
            }
        }

        function startProgressMonitoring(workflowId) {
            progressInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/workflow/status/${workflowId}`);
                    if (!response.ok) return;

                    const status = await response.json();
                    updateProgress(status);

                    // ì™„ë£Œ/ì‹¤íŒ¨/ì·¨ì†Œ ì‹œ ëª¨ë‹ˆí„°ë§ ì¤‘ë‹¨
                    if (['completed', 'failed', 'cancelled'].includes(status.status)) {
                        stopProgressMonitoring();
                        handleWorkflowCompletion(status);
                    }
                } catch (error) {
                    console.error('ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
                }
            }, 1000);
        }

        function stopProgressMonitoring() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
        }

        function updateProgress(status) {
            document.getElementById('statusMessage').textContent = status.message;
            document.getElementById('progressFill').style.width = status.progress_percentage + '%';
            document.getElementById('stepInfo').textContent = `${status.current_step}/${status.total_steps} ë‹¨ê³„: ${status.step_name}`;
        }

        function handleWorkflowCompletion(status) {
            if (status.status === 'completed') {
                showSuccess(status.results);
            } else if (status.status === 'failed') {
                showError(status.message);
            } else if (status.status === 'cancelled') {
                showError('ì›Œí¬í”Œë¡œìš°ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
            resetForm();
        }

        function showProgress() {
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('resultContainer').style.display = 'none';
        }

        function showSuccess(results) {
            const container = document.getElementById('resultContainer');
            const content = document.getElementById('resultContent');

            let html = '<h3>ğŸ‰ ìë™í™” ì™„ë£Œ!</h3>';

            if (results.generation) {
                html += `<p><strong>ğŸ“ ìƒì„±ëœ ë¸”ë¡œê·¸:</strong> ${results.generation.length || 'ì•Œ ìˆ˜ ì—†ìŒ'}ì</p>`;
            }

            if (results.quality) {
                html += '<div class="quality-scores">';
                html += `<div class="quality-item">`;
                html += `<strong>ì „ì²´ í’ˆì§ˆ ì ìˆ˜</strong>`;
                html += `<div class="quality-score ${getScoreClass(results.quality.overall_score)}">${(results.quality.overall_score * 100).toFixed(0)}ì </div>`;
                html += `</div>`;

                const detailed = results.quality.detailed_scores || {};
                Object.entries(detailed).forEach(([key, value]) => {
                    const name = {
                        'naver_compliance': 'ë„¤ì´ë²„ ì •ì±… ì¤€ìˆ˜',
                        'keyword_quality': 'í‚¤ì›Œë“œ í’ˆì§ˆ',
                        'personal_authenticity': 'ê°œì¸ ê²½í—˜ ì§„ì •ì„±',
                        'technical_quality': 'ê¸°ìˆ ì  í’ˆì§ˆ'
                    }[key] || key;

                    html += `<div class="quality-item">`;
                    html += `<strong>${name}</strong>`;
                    html += `<div class="quality-score ${getScoreClass(value)}">${(value * 100).toFixed(0)}ì </div>`;
                    html += `</div>`;
                });
                html += '</div>';
            }

            if (results.upload && results.upload.success) {
                html += '<p><strong>ğŸ“¤ ë„¤ì´ë²„ ì—…ë¡œë“œ:</strong> âœ… ì„ì‹œì €ì¥ ì™„ë£Œ</p>';
            } else if (results.upload) {
                html += `<p><strong>âš ï¸ ë„¤ì´ë²„ ì—…ë¡œë“œ:</strong> ì‹¤íŒ¨ - ${results.upload.error}</p>`;
            }

            content.innerHTML = html;
            container.className = 'result-container result-success';
            container.style.display = 'block';
        }

        function showError(message) {
            const container = document.getElementById('resultContainer');
            const content = document.getElementById('resultContent');

            content.innerHTML = `<h3>âŒ ì˜¤ë¥˜ ë°œìƒ</h3><p>${message}</p>`;
            container.className = 'result-container result-error';
            container.style.display = 'block';
        }

        function getScoreClass(score) {
            if (score >= 0.9) return 'score-excellent';
            if (score >= 0.8) return 'score-good';
            if (score >= 0.7) return 'score-fair';
            return 'score-poor';
        }

        function resetForm() {
            document.getElementById('startBtn').disabled = false;
            document.getElementById('cancelBtn').disabled = true;
            currentWorkflowId = null;
        }
    </script>
</body>
</html>